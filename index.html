<html>
<body onclick="stop=true;">

<audio id="tick" src="Tick.ogg" autostart="true" ></audio>

<div id="container">
	<div id="pulso" class="pulso" style="top: 200px; left:10px; position:absolute;">
	    pulso
	</div>
</div>
<div id="patternTemplate" style="display: none; left: 2000;">
	<div class="nota" id="nota1">
		1
	</div>
	<div class="nota" style="top: 100px; left:200px;">
		2
	</div>

	<div class="nota" style="top: 200px; left:400px;">
		4
	</div>

	<div class="nota" style="top: 300px; left:300px;">
		3
	</div>
</div>

</body>

</html>
<style>
#container {
	width: 100%;
	height: 100%;
	background-color: aaaaaa;
	overflow:hidden;
}
    .compas {
        position: relative;
        top: 100px;
        left:0px;
    }

    .notota {
        background-color: red;
		        -moz-border-radius: 20px;
        border-radius: 20px;
        border-color:red;
        color:white;
        padding-left:12px;
        padding-right:12px;
        padding-top:5px;
        padding-bottom:5px;
        font-size:1.5em;
        width: 16px;
        position: relative;
    }

    .nota {
        background-color: #999999;
        -moz-border-radius: 20px;
        border-radius: 20px;
        border-color:red;
        color:white;
        padding-left:12px;
        padding-right:12px;
        padding-top:5px;
        padding-bottom:5px;
        font-size:1.5em;
        width: 16px;
        position: relative;
    }

    .pulso {
        background-color: black;
        -moz-border-radius: 20px;
        border-radius: 20px;
        border-color:black;
        color:white;
        padding-left:12px;
        padding-right:12px;
        padding-top:5px;
        padding-bottom:5px;
        font-size:1.5em;
        position: absolute;
    }

</style>

<script>
var stop = false;
var start_x = parseInt(window.getComputedStyle(document.getElementById('container')).width.replace('px',''));
var lastTime = -1;
var fps = 30;
var bpm = 60000 / 60;
var global_speed = 120/1000;
var bpm_progress = 0;
var patterns=[];
var lastPatternId=0;

function createPattern() {
	var newPattern = document.createElement("DIV");
	var divContainer = document.getElementById('container');

	newPattern.innerHTML=document.getElementById('patternTemplate').innerHTML;
	newPattern.className='compas';
	newPattern.id='pat'+lastPatternId;
	newPattern.style.left="2000px";
	lastPatternId++;
	divContainer.appendChild(newPattern);
    if (newPattern.x == undefined) newPattern.x = start_x;
    if (newPattern.y == undefined) newPattern.y = 100;
    if (newPattern.w == undefined) newPattern.w = parseInt(window.getComputedStyle(newPattern).width.replace('px',''));
    if (newPattern.speed == undefined) newPattern.speed = 1;
    patterns.push(newPattern);
}

function formatDiv(index,progress) {
    var divCompas = patterns[index];
    if (divCompas.x > -divCompas.w) {
		if (divCompas.offsetLeft + document.getElementById('nota1').offsetLeft < 150) {
			var nota=document.getElementById('nota1');
			nota.innerHTML="notota";
			nota.className="notota";
			console.log(divCompas.offsetLeft +document.getElementById('nota1').offsetLeft);
		}
        divCompas.x -= (divCompas.speed * global_speed * (progress==0?1:progress));
        divCompas.style.left = divCompas.x +'px';
    } 
    else {
        divCompas.x = start_x;
    }
}

function doAnimation(timestamp) {
	var progress = 0;

	if (lastTime < 0) {
	    lastTime = timestamp;
	} else {
	    progress = timestamp - lastTime;
	    bpm_progress += progress;
	    if (progress >= 1000/fps) {
	        lastTime = timestamp;
	  } else {
	        requestAnimationFrame(doAnimation);
	        return;  
	  }
	}
	  

	formatDiv(0, progress);
//	formatDiv('test1', progress);

	if (bpm_progress > bpm) {
	    var divPulso = document.getElementById('pulso');
	    divPulso.innerHTML="P";
		var soundTick = document.getElementById('tick');
        soundTick.play();

	    setTimeout(function () {
	        var divPulso = document.getElementById('pulso');
	        divPulso.innerHTML="";
	    },100);
	    bpm_progress = 0;
	}


	if (!stop) {
	    requestAnimationFrame(doAnimation);
	}
}

// Start animation
createPattern();
window.requestAnimationFrame(doAnimation);
</script>
